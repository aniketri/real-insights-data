services:
  - type: web
    name: real-insights-api
    env: node
    plan: free                 # FREE: 512MB RAM, 0.1 CPU, sleeps after 15min
    region: oregon
    
    # Optimized build for free tier
    buildCommand: |
      npm install -g pnpm@9.6.0 && 
      pnpm install --frozen-lockfile --prefer-offline &&
      echo "Generating Prisma client..." && 
      pnpm db:generate && 
      echo "Building db package..." && 
      pnpm --filter @repo/db build && 
      cd apps/api && pnpm exec prisma generate --schema=../../packages/db/schema.prisma && cd ../.. &&
      echo "Building API..." && 
      pnpm --filter api build && 
      echo "Free tier build complete"
      
    startCommand: cd apps/api && pnpm start:prod
    
    autoDeploy: true
    # numInstances: 1  # Free tier only allows 1 instance
    
    # Environment variables optimized for free tier
    envVars:
      - key: NODE_ENV
        value: production
        
      # Database connection
      - key: DATABASE_URL
        fromDatabase:
          name: real-insights-db
          property: connectionString
          
      # Authentication
      - key: JWT_SECRET
        generateValue: true
      - key: NEXTAUTH_SECRET
        sync: false
        
      # External services (free tiers)
      - key: RESEND_API_KEY
        sync: false
      - key: GOOGLE_CLIENT_ID
        sync: false
      - key: GOOGLE_CLIENT_SECRET
        sync: false
      - key: MICROSOFT_CLIENT_ID
        sync: false
      - key: MICROSOFT_CLIENT_SECRET
        sync: false
      - key: FRONTEND_URL
        sync: false
        
      # Free tier performance optimizations
      - key: NODE_OPTIONS
        value: "--max-old-space-size=400"  # Conservative for 512MB limit
      - key: DATABASE_POOL_SIZE
        value: "5"                         # Small pool for M0 (100 connections)
      - key: DATABASE_CONNECTION_LIMIT
        value: "20"                        # Conservative limit
      - key: CACHE_TTL
        value: "1800"                      # 30-minute cache (longer for free tier)
      - key: MAX_QUERY_RESULTS
        value: "1000"                      # Limit result sets
      - key: ENABLE_KEEP_ALIVE
        value: "true"                      # Prevent sleep with frontend pings
        
    # Health check (helps with monitoring)
    healthCheckPath: /api/v1/health
    
    # No disk needed for free tier
    
databases:
  - name: real-insights-db
    databaseName: real_insights
    plan: free                 # FREE: 512MB storage, 100 connections max
    region: oregon
    
    # No IP restrictions for free tier
    ipAllowList: []

# Comments for future upgrades:
# 
# When you're ready to upgrade (500+ users or $50+ revenue):
# 1. Change API plan to "starter" ($7/month) - removes sleep
# 2. Change DB plan to "starter" ($7/month) - 2GB storage
# 3. Add Redis when you reach 1000+ users:
#    - type: redis
#      name: real-insights-redis  
#      plan: starter
#      region: oregon
#
# When you're ready for 10K users ($200+ revenue):
# 1. Change API plan to "pro" with numInstances: 5
# 2. Change DB plan to "pro" or use MongoDB Atlas M20
# 3. Upgrade Redis to "standard" plan
# 4. Add auto-scaling configuration 